<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no" />

  <!-- PWA Meta Tags -->
  <meta name="description" content="Your daily companion for health, productivity, and personal growth tracking" />
  <meta name="theme-color" content="#f59e0b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Vita" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="format-detection" content="telephone=no" />

  <!-- PWA Manifest and Icons -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" href="icon-192.svg" type="image/svg+xml" />

  <title>Vita ‚Äî Personal Development Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  </style>
</head>
<body class="bg-slate-900 text-gray-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function getTodayLocal() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function VitaApp() {
      console.log('VitaApp component starting...');
      const [view, setView] = useState('today');
      console.log('View state initialized:', view);

      const today = getTodayLocal();
      console.log('Today date:', today);

      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [journal, setJournal] = useState('');
      const [water, setWater] = useState(0);
      const [saas, setSaas] = useState('');
      const [deepWork, setDeepWork] = useState('');
      const [talks, setTalks] = useState('');
      const [lifeEvents, setLifeEvents] = useState([]);
      const [showEventModal, setShowEventModal] = useState(false);
      const [newEvent, setNewEvent] = useState({ name: '', type: 'birthday', month: '', day: '', year: '', recurrence: 'yearly', notes: '' });
      const [eventNotifications, setEventNotifications] = useState([]);
      const [miles, setMiles] = useState('');
      const [weights, setWeights] = useState({});
      const [workout, setWorkout] = useState(null);
      const [history, setHistory] = useState([]);
      const [viewingDay, setViewingDay] = useState(null);
      const [showAllHistory, setShowAllHistory] = useState(false);
      const [nutritionData, setNutritionData] = useState({});
      const [showAddFood, setShowAddFood] = useState(false);
      const [selectedMeal, setSelectedMeal] = useState('breakfast');
      const [saveStatus, setSaveStatus] = useState('');
      const [isExisting, setIsExisting] = useState(false);
      const [energyLevel, setEnergyLevel] = useState(null);
      const [knowledgeBase, setKnowledgeBase] = useState([]); // Personal notes and insights
      const [spacedRepetition, setSpacedRepetition] = useState([]); // Ideas to remember
      const [currentBookApplication, setCurrentBookApplication] = useState(null); // Today's application prompt
      const [challenges, setChallenges] = useState([]); // Active challenges
      const [completedChallenges, setCompletedChallenges] = useState([]); // Completed challenges
      const [badges, setBadges] = useState([]); // Earned badges
      const [showCreateChallenge, setShowCreateChallenge] = useState(false);
      const [aiCoachInsights, setAiCoachInsights] = useState({}); // AI coach analysis and insights
      const [coachMode, setCoachMode] = useState('daily'); // daily, weekly, monthly
      const [showAddNote, setShowAddNote] = useState(false);
      const [showAddRepetition, setShowAddRepetition] = useState(false);
      const [newNote, setNewNote] = useState({ content: '', source: '', category: '', tags: '' });
      const [newRepetitionItem, setNewRepetitionItem] = useState({ content: '', source: '' });
      const [readingProgress, setReadingProgress] = useState({
        booksRead: 0,
        pagesRead: 0,
        insightsGained: 0,
        currentStreak: 0,
        longestStreak: 0,
        lastReadingDate: null
      });
      const [showReadingModal, setShowReadingModal] = useState(false);
      const [readingEntry, setReadingEntry] = useState({
        bookTitle: '',
        pagesRead: '',
        insights: '',
        notes: ''
      });
      const [readingHistory, setReadingHistory] = useState([]);
      const [manualWorkoutType, setManualWorkoutType] = useState(null); // Manual override for today's workout
      const [categoryAffirmations, setCategoryAffirmations] = useState({
        productivity: '',
        health: '',
        leadership: '',
        mindset: ''
      }); // Current affirmations for each category
      const [foodSearchTerm, setFoodSearchTerm] = useState(''); // Search term for nutrition foods
      const [showDataModal, setShowDataModal] = useState(false); // Data management modal

      console.log('All state initialized successfully');

      const rotation = ['back-biceps', 'legs', 'chest-triceps', 'shoulders', 'full-body', 'core-abs', 'cardio-conditioning', 'running'];

      const exercises = {
        'back-biceps': [
          ['Deadlifts 4x6', 'Bent Rows 4x8', 'Pull-ups 3x10', 'Barbell Curls 3x12', 'Hammer Curls 3x10'],
          ['T-Bar Rows 4x8', 'Lat Pulldowns 4x10', 'Cable Rows 3x12', 'Preacher Curls 3x12', 'Concentration Curls 3x10'],
          ['Romanian Deadlifts 4x8', 'Seated Rows 4x10', 'Face Pulls 3x12', 'EZ Bar Curls 3x12', 'Cable Curls 3x10'],
          ['Rack Pulls 4x6', 'Pendlay Rows 4x8', 'Assisted Pull-ups 3x8', 'Dumbbell Curls 3x12', 'Reverse Curls 3x10']
        ],
        'legs': [
          ['Squats 4x8', 'Romanian Deadlifts 4x10', 'Leg Press 3x12', 'Lunges 3x10', 'Calf Raises 4x15'],
          ['Front Squats 4x8', 'Bulgarian Splits 3x10', 'Leg Curls 4x12', 'Leg Extensions 3x12', 'Seated Calf 4x15'],
          ['Box Squats 4x8', 'Trap Bar Deadlifts 4x8', 'Hack Squat 3x10', 'Walking Lunges 3x12', 'Standing Calf 4x15'],
          ['Pause Squats 4x6', 'Deficit Deadlifts 4x8', 'Belt Squat 3x12', 'Step-ups 3x10', 'Leg Press Calf 4x20']
        ],
        'chest-triceps': [
          ['Bench Press 4x8', 'Incline DB Press 4x10', 'Dips 3x12', 'Tricep Pushdowns 3x12', 'Overhead Ext 3x10'],
          ['Incline Bench 4x8', 'Flat DB Press 4x10', 'Cable Flyes 3x12', 'Close Grip Bench 3x10', 'Skull Crushers 3x12'],
          ['Floor Press 4x8', 'Incline Flyes 4x10', 'Diamond Push-ups 3x12', 'Rope Pushdowns 3x12', 'Tricep Kickbacks 3x15'],
          ['Board Press 4x6', 'Hammer Press 4x8', 'Ring Dips 3x10', 'V-Bar Pushdowns 3x12', 'Overhead Rope Ext 3x12']
        ],
        'shoulders': [
          ['Military Press 4x8', 'Lateral Raises 4x12', 'Rear Delt Flyes 4x15', 'Face Pulls 3x12', 'Shrugs 4x10'],
          ['Arnold Press 4x8', 'Front Raises 4x12', 'Bent-over Raises 4x15', 'Upright Rows 3x10', 'Farmer Walks 3x30s'],
          ['Push Press 4x6', 'Cable Laterals 4x12', 'Machine Raises 4x15', 'Band Pull-aparts 3x15', 'Dumbbell Shrugs 4x12'],
          ['Z Press 4x6', 'Single-arm Laterals 4x12', 'Reverse Flyes 4x15', 'Y Raises 3x12', 'Trap Raises 4x10']
        ],
        'full-body': [
          ['Deadlifts 4x6', 'Bench Press 4x8', 'Pull-ups 3x8', 'Squats 4x8', 'Overhead Press 4x8'],
          ['Romanian DL 4x8', 'Incline Press 4x8', 'Rows 4x10', 'Front Squats 4x8', 'Dips 3x10'],
          ['Trap Bar DL 4x8', 'Floor Press 4x8', 'Lat Pulldowns 4x10', 'Bulgarian Split 3x10', 'Push-ups 3x15'],
          ['Deficit DL 4x6', 'Close Grip Bench 4x8', 'Face Pulls 3x12', 'Pause Squats 4x6', 'Diamond Push-ups 3x12']
        ],
        'core-abs': [
          ['Planks 3x45s', 'Russian Twists 4x20', 'Leg Raises 4x15', 'Bicycle Crunches 4x20', 'Mountain Climbers 4x30s'],
          ['Dead Bugs 4x12', 'Pallof Press 3x12', 'Flutter Kicks 4x30s', 'V-ups 4x15', 'Woodchoppers 3x15'],
          ['Ab Wheel 4x10', 'Dragon Flags 4x8', 'Hollow Body Hold 3x30s', 'Side Planks 3x30s', 'Reverse Crunches 4x15'],
          ['Weighted Sit-ups 4x12', 'Cable Crunches 4x15', 'Farmers Carry 3x40s', 'Stir the Pot 3x20s', 'Toes to Bar 4x10']
        ],
        'cardio-conditioning': [
          ['Burpees 4x10', 'Mountain Climbers 4x30s', 'Jump Squats 4x15', 'High Knees 4x30s', 'Box Jumps 4x10'],
          ['Battle Ropes 4x30s', 'Rowing Sprints 8x30s', 'Kettlebell Swings 4x20', 'Slam Balls 4x15', 'Wall Balls 4x15'],
          ['Bike Sprints 8x20s', 'Assault Bike 4x30s', 'Ski Erg 4x30s', 'Fan Bike 4x30s', 'Echo Bike 4x30s'],
          ['Bear Crawls 4x30s', 'Crab Walks 4x30s', 'Broad Jumps 4x10', 'Sprint Intervals 8x20s', 'Hill Sprints 6x30s']
        ]
      };

      const tasks = {
        core: [
          { id: 'cold', t: 'Cold shower/exposure' },
          { id: 'workout', t: 'Lifted/Ran (workout completed)' },
          { id: 'sun', t: 'Morning sunlight 10+ min' },
          { id: 'sleep', t: '7-8hr sleep scheduled' },
          { id: 'priorities', t: 'Wrote down 3 priorities for today' },
          { id: 'deep', t: '2-3hr deep work (phone locked away)' },
          { id: 'progress', t: 'Moved the product forward (tangible progress)' },
          { id: 'read', t: 'Read for 30 minutes' },
          { id: 'connect', t: 'Had real conversation with someone important (non-work)' }
        ],
        lead: [
          { id: 'no', t: 'Said no to distraction' },
          { id: 'talk', t: 'Had hard conversation' },
          { id: 'own', t: 'Owned mistake no excuses' },
          { id: 'help', t: 'Helped someone' },
          { id: 'hard', t: 'Did hardest thing first' }
        ],
        comm: [
          { id: 'rec', t: 'Recorded 60s pitch' },
          { id: 'pause', t: 'Paused before responding' },
          { id: 'short', t: 'Rewrote 50% shorter' },
          { id: 'clear', t: 'Explained product clearly' }
        ]
      };

      const labels = {
        'back-biceps': 'Back & Biceps',
        'legs': 'Legs',
        'chest-triceps': 'Chest & Triceps',
        'shoulders': 'Shoulders',
        'full-body': 'Full Body',
        'core-abs': 'Core & Abs',
        'cardio-conditioning': 'Cardio Conditioning',
        'running': 'Running'
      };

      function makeStorage() {
        if (window.storage && window.storage.get && window.storage.set && window.storage.list) {
          return window.storage;
        }
        return {
          get: async (key) => {
            const val = localStorage.getItem(key);
            return val ? { value: val } : null;
          },
          set: async (key, value) => {
            localStorage.setItem(key, value);
            return { key, value };
          },
          list: async (prefix) => {
            const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
            return { keys };
          }
        };
      }

      useEffect(() => { loadData(); }, []);

      // Load nutrition data on component mount
      useEffect(() => {
        const saved = localStorage.getItem('vita-nutrition');
        if (saved) {
          try {
            setNutritionData(JSON.parse(saved));
          } catch (e) {
            console.error('Error loading nutrition data:', e);
          }
        }
      }, []);

      // Backup reminder check
      useEffect(() => {
        const checkBackupReminder = () => {
          const lastBackup = localStorage.getItem('vita-last-backup');
          const daysSinceBackup = lastBackup ?
            Math.floor((Date.now() - new Date(lastBackup).getTime()) / (1000 * 60 * 60 * 24)) : 999;

          if (daysSinceBackup > 7) {
            // Show reminder after a delay to not be intrusive
            setTimeout(() => {
              if (confirm(`It's been ${daysSinceBackup} days since your last Vita backup. Would you like to export your data now to prevent data loss?`)) {
                const exportData = () => {
                  const exportData = {
                    version: '1.1.0',
                    timestamp: new Date().toISOString(),
                    app: 'Vita - Personal Development Tracker',
                    data: {
                      history,
                      nutritionData,
                      knowledgeBase,
                      spacedRepetition,
                      currentBookApplication,
                      challenges,
                      completedChallenges,
                      badges,
                      aiCoachInsights,
                      readingProgress,
                      readingHistory
                    }
                  };

                  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `vita-backup-${new Date().toISOString().split('T')[0]}.json`;
                  a.click();
                  URL.createObjectURL(url);

                  // Update last backup timestamp
                  localStorage.setItem('vita-last-backup', new Date().toISOString());
                };
                exportData();
              }
            }, 3000); // 3 second delay
          }
        };

        // Check on component mount and periodically
        checkBackupReminder();
        const interval = setInterval(checkBackupReminder, 24 * 60 * 60 * 1000); // Daily check

        return () => clearInterval(interval);
      }, []);

      // Load knowledge data on component mount
      useEffect(() => {
        // Load knowledge base
        const savedKnowledge = localStorage.getItem('vita-knowledge-base');
        if (savedKnowledge) {
          try {
            setKnowledgeBase(JSON.parse(savedKnowledge));
          } catch (e) {
            console.error('Error loading knowledge base:', e);
          }
        }

        // Load spaced repetition items
        const savedRepetition = localStorage.getItem('vita-spaced-repetition');
        if (savedRepetition) {
          try {
            const repetitionData = JSON.parse(savedRepetition);
            // Filter out completed items and update due dates
            const now = new Date();
            const activeItems = repetitionData.filter(item => {
              const dueDate = new Date(item.nextReview);
              return dueDate <= now;
            });
            setSpacedRepetition(activeItems);
          } catch (e) {
            console.error('Error loading spaced repetition:', e);
          }
        }

        // Load challenges and badges
        const savedChallenges = localStorage.getItem('vita-challenges');
        if (savedChallenges) {
          try {
            const challengeData = JSON.parse(savedChallenges);
            setChallenges(challengeData.filter(c => !c.completed));
            setCompletedChallenges(challengeData.filter(c => c.completed));
          } catch (e) {
            console.error('Error loading challenges:', e);
          }
        }

        const savedBadges = localStorage.getItem('vita-badges');
        if (savedBadges) {
          try {
            setBadges(JSON.parse(savedBadges));
          } catch (e) {
            console.error('Error loading badges:', e);
          }
        }

        // Load AI coach insights
        const savedCoachInsights = localStorage.getItem('vita-ai-coach');
        if (savedCoachInsights) {
          try {
            setAiCoachInsights(JSON.parse(savedCoachInsights));
          } catch (e) {
            console.error('Error loading AI coach insights:', e);
          }
        }

        // Load reading progress
        const savedReadingProgress = localStorage.getItem('vita-reading-progress');
        if (savedReadingProgress) {
          try {
            setReadingProgress(JSON.parse(savedReadingProgress));
          } catch (e) {
            console.error('Error loading reading progress:', e);
          }
        }

        // Load reading history
        const savedReadingHistory = localStorage.getItem('vita-reading-history');
        if (savedReadingHistory) {
          try {
            setReadingHistory(JSON.parse(savedReadingHistory));
          } catch (e) {
            console.error('Error loading reading history:', e);
          }
        }

        // Generate today's book application
        generateTodaysApplication();
      }, []);

      // Check event notifications when lifeEvents change
      useEffect(() => {
        checkEventNotifications();
      }, [lifeEvents]);

      // Auto-save workout progress when navigating away from workouts tab
      useEffect(() => {
        if (view !== 'workouts' && workout && workout.type) {
          // Save current workout progress to localStorage
          const workoutProgress = {
            type: workout.type,
            var: workout.var,
            weights: weights,
            miles: miles,
            savedAt: new Date().toISOString()
          };
          try {
            localStorage.setItem('vita-workout-progress', JSON.stringify(workoutProgress));
          } catch (e) {
            console.error('Error saving workout progress:', e);
          }
        }
      }, [view, workout, weights, miles]); // Include all dependencies

      // Load saved workout progress when component mounts
      useEffect(() => {
        const saved = localStorage.getItem('vita-workout-progress');
        if (saved) {
          try {
            const workoutProgress = JSON.parse(saved);
            // Only restore if it's recent (within last 24 hours) and not completed today
            const savedTime = new Date(workoutProgress.savedAt);
            const now = new Date();
            const hoursDiff = (now - savedTime) / (1000 * 60 * 60);

            if (hoursDiff < 24 && data && !data.workoutDone) {
              setWorkout({ type: workoutProgress.type, var: workoutProgress.var });
              // Handle backward compatibility: convert single weights to arrays if needed
              const processedWeights = {};
              if (workoutProgress.weights) {
                for (const [exercise, weight] of Object.entries(workoutProgress.weights)) {
                  if (Array.isArray(weight)) {
                    processedWeights[exercise] = weight;
                  } else if (weight) {
                    // Convert single weight to array for backward compatibility
                    processedWeights[exercise] = [weight];
                  }
                }
              }
              setWeights(processedWeights);
              setMiles(workoutProgress.miles || '');
            }
          } catch (e) {
            console.error('Error loading workout progress:', e);
          }
        }
      }, []);

      async function loadData() {
        setLoading(true);
        const storage = makeStorage();
        const initialData = { date: today, done: [], journal: '', water: 0, saas: '', deepWork: '', talks: '', miles: '', weights: {}, mood: null, workoutDone: false, energyLevel: null };
        try {
          // Load today's data
        try {
          const td = await storage.get(`day:${today}`);
          if (td && td.value) {
            const raw = (typeof td.value === 'string') ? td.value : '';
            const d = JSON.parse(raw || '{}');
            const merged = { ...initialData, ...d };
              const cleanData = JSON.parse(JSON.stringify(merged));
              setData(cleanData);
              setJournal(cleanData.journal || '');
              setWater(cleanData.water || 0);
              setSaas(cleanData.saas || '');
              setDeepWork(cleanData.deepWork || '');
              setTalks(cleanData.talks || '');
              setMiles(cleanData.miles || '');
              setWeights(cleanData.weights || {});
            setIsExisting(true);
          } else {
              setData(JSON.parse(JSON.stringify(initialData)));
              setJournal('');
              setWater(0);
              setSaas('');
              setDeepWork('');
              setTalks('');
              setMiles('');
              setWeights({});
              setIsExisting(false);
            }
          } catch (e) {
            console.error('Error loading today\'s data:', e);
            setData(JSON.parse(JSON.stringify(initialData)));
            setJournal('');
            setWater(0);
            setSaas('');
            setDeepWork('');
            setTalks('');
            setMiles('');
            setWeights({});
            setIsExisting(false);
          }

          // Load workout rotation
          try {
          const wr = await storage.get('workout-rotation');
          if (wr && wr.value) {
              const workoutData = JSON.parse(wr.value);
              setWorkout(workoutData);
            } else {
              setWorkout({ type: 'back-biceps', var: 0 });
            }
          } catch (e) {
            console.error('Error loading workout rotation:', e);
            setWorkout({ type: 'back-biceps', var: 0 });
          }

          // Load life events
          try {
            const savedEvents = localStorage.getItem('vita-life-events');
            if (savedEvents) {
              setLifeEvents(JSON.parse(savedEvents));
            }
          } catch (e) {
            console.error('Error loading life events:', e);
          }

          // Load history
          await refreshHistory();
        } catch (e) {
          console.error('Critical error in loadData:', e);
          setData(JSON.parse(JSON.stringify(initialData)));
          setWorkout({ type: 'back-biceps', var: 0 });
          setHistory([]);
        } finally {
          setLoading(false);
        }
      }

      async function refreshHistory() {
        const storage = makeStorage();
        try {
        const res = await storage.list('day:');
        if (res?.keys) {
          const hist = await Promise.all(res.keys.map(async k => {
            try {
              const r = await storage.get(k);
                if (!r || !r.value) return null;
              const raw = (typeof r.value === 'string') ? r.value : '';
                const parsed = JSON.parse(raw || '{}');
                // Ensure we have all fields for proper display
                return {
                  date: parsed.date || k.replace('day:', ''),
                  done: parsed.done || [],
                  journal: parsed.journal || '',
                  water: parsed.water || 0,
                  saas: parsed.saas || '',
                  deepWork: parsed.deepWork || '',
                  talks: parsed.talks || '',
                  miles: parsed.miles || '',
                  weights: parsed.weights || {},
                  workoutDone: parsed.workoutDone || false,
                  workoutType: parsed.workoutType || null,
                  workoutExercises: parsed.workoutExercises || null,
                  mood: parsed.mood || null,
                  energyLevel: parsed.energyLevel || null,
                  // Add nutrition data for this day
                  nutritionData: (() => {
                    try {
                      const nutritionKey = parsed.date || k.replace('day:', '');
                      const savedNutrition = localStorage.getItem('vita-nutrition');
                      if (savedNutrition) {
                        const nutritionData = JSON.parse(savedNutrition);
                        return nutritionData[nutritionKey] || null;
                      }
                      return null;
                    } catch (e) {
                      console.error('Error loading nutrition data for history:', e);
                      return null;
                    }
                  })()
                };
              } catch (e) {
                console.error('Error loading history item:', k, e);
                return null;
              }
            }));
            const validHistory = hist.filter(Boolean);
            setHistory(validHistory.sort((a, b) => new Date(b.date) - new Date(a.date)));
          } else {
            setHistory([]);
          }
        } catch (e) {
          console.error('Error refreshing history:', e);
          setHistory([]);
        }
      }

      async function save(d) {
        try {
          setSaveStatus('Saving‚Ä¶');
          const storage = makeStorage();
          // Ensure we have a clean copy of the data
          const cleanData = JSON.parse(JSON.stringify(d));
          await storage.set(`day:${today}`, JSON.stringify(cleanData));
          setSaveStatus('Saved ‚úì');
          setTimeout(() => setSaveStatus(''), 2000);
          await refreshHistory();
          setIsExisting(true);
        } catch (e) {
          console.error('Save error', e);
          setSaveStatus('Save failed ‚ùå');
          setTimeout(() => setSaveStatus(''), 3000);
        }
      }

      async function startNewDay() {
        if (!window.confirm('Start a new day? This will snapshot and save the current entry, then reset Today to a fresh entry.')) return;
        const storage = makeStorage();
        try {
          if (data && data.date) {
            await storage.set(`day:${data.date}`, JSON.stringify(data));
          }
          const newData = { date: today, done: [], journal: '', water: 0, saas: '', deepWork: '', talks: '', miles: '', weights: {}, mood: null, workoutDone: false, energyLevel: null };
          setData(JSON.parse(JSON.stringify(newData)));
          setJournal(''); setWater(0); setSaas(''); setDeepWork(''); setTalks(''); setMiles(''); setWeights({});
          await storage.set(`day:${today}`, JSON.stringify(newData));
          await refreshHistory();
          setIsExisting(false);
          setSaveStatus('New day started');
          setTimeout(() => setSaveStatus(''), 2000);
        } catch (e) {
          console.error('New day error', e);
        }
      }

      async function completeWorkout() {
        const storage = makeStorage();
        const selectedWorkoutType = manualWorkoutType || workout.type;

        // Validate that weights are entered for non-running workouts
        if (selectedWorkoutType !== 'running') {
          const workoutExercises = exercises[selectedWorkoutType][workout.var];
          const missingWeights = workoutExercises.filter(ex => {
            const exerciseWeights = weights[ex] || [];
            const setMatch = ex.match(/(\d+)x\d+/);
            const numSets = setMatch ? parseInt(setMatch[1]) : 1;
            // Check if all sets have weights entered
            return exerciseWeights.length < numSets || exerciseWeights.slice(0, numSets).some(w => !w || w === '');
          });
          if (missingWeights.length > 0) {
            alert(`Please enter weights for all sets in: ${missingWeights.join(', ')}`);
            return;
          }
        }
        const nd = {
          ...data,
          workoutType: selectedWorkoutType,
          workoutDone: true,
          miles: (selectedWorkoutType === 'running' ? miles : undefined),
          weights: (selectedWorkoutType !== 'running' ? { ...weights } : undefined),
          workoutExercises: (selectedWorkoutType !== 'running' ? exercises[selectedWorkoutType][workout.var] : undefined),
          workoutDate: new Date().toISOString()
        };
        const cleanData = JSON.parse(JSON.stringify(nd));
        setData(cleanData);
        await save(cleanData);

        // Show success message
        setSaveStatus('Workout completed! üí™');
        setTimeout(() => setSaveStatus(''), 2000);

        // Update workout rotation
        const idx = rotation.indexOf(workout.type);
        const nextWorkout = { type: rotation[(idx + 1) % rotation.length], var: 0 };
        setWorkout(nextWorkout);
        setWeights({});
        setMiles('');

        // Save the workout rotation
        try {
          await storage.set('workout-rotation', JSON.stringify(nextWorkout));
        } catch (e) {
          console.error('Failed to save workout rotation', e);
        }
      }

      // Life Events functions
      const getNextOccurrence = (event) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth() + 1;
        const eventMonth = parseInt(event.month);
        const eventDay = parseInt(event.day);
        let nextDate;
        
        if (event.recurrence === 'yearly' || event.type === 'birthday') {
          nextDate = new Date(currentYear, eventMonth - 1, eventDay);
          if (nextDate < today) nextDate = new Date(currentYear + 1, eventMonth - 1, eventDay);
        } else if (event.recurrence === 'monthly') {
          nextDate = new Date(currentYear, currentMonth - 1, eventDay);
          if (nextDate < today) nextDate = new Date(currentYear, currentMonth, eventDay);
        } else if (event.recurrence === 'quarterly') {
          const months = [eventMonth, eventMonth + 3, eventMonth + 6, eventMonth + 9].map(m => ((m - 1) % 12) + 1);
          for (let m of months) {
            const year = m < currentMonth ? currentYear + 1 : currentYear;
            const testDate = new Date(year, m - 1, eventDay);
            if (testDate >= today) { nextDate = testDate; break; }
          }
          if (!nextDate) nextDate = new Date(currentYear + 1, eventMonth - 1, eventDay);
        } else {
          nextDate = new Date(event.year || currentYear, eventMonth - 1, eventDay);
        }
        return nextDate;
      };

      const checkEventNotifications = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const notifications = lifeEvents.map(event => {
          const nextDate = getNextOccurrence(event);
          const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
          
          if (daysUntil >= 0 && daysUntil <= 30) {
            return { ...event, nextDate, daysUntil, isToday: daysUntil === 0, isThisWeek: daysUntil <= 7 && daysUntil > 0, isUrgent: daysUntil <= 3 };
          }
          return null;
        }).filter(n => n !== null).sort((a, b) => a.daysUntil - b.daysUntil);

        setEventNotifications(notifications);
      };

      const addLifeEvent = () => {
        if (newEvent.name && newEvent.month && newEvent.day) {
          const event = { ...newEvent, id: Date.now().toString(), createdAt: new Date().toISOString() };
          const updatedEvents = [...lifeEvents, event];
          setLifeEvents(updatedEvents);
          localStorage.setItem('vita-life-events', JSON.stringify(updatedEvents));
          setNewEvent({ name: '', type: 'birthday', month: '', day: '', year: '', recurrence: 'yearly', notes: '' });
          setShowEventModal(false);
          checkEventNotifications();
        }
      };

      const removeLifeEvent = (id) => {
        const updatedEvents = lifeEvents.filter(e => e.id !== id);
        setLifeEvents(updatedEvents);
        localStorage.setItem('vita-life-events', JSON.stringify(updatedEvents));
        checkEventNotifications();
      };

      async function toggle(id) {
        if (!data) return;
        const done = data.done.includes(id) ? data.done.filter(x => x !== id) : [...data.done, id];
        const nd = { ...data, done };
        const cleanData = JSON.parse(JSON.stringify(nd));
        setData(cleanData);
        await save(cleanData);
      }

      async function updateWater(n) {
        const nw = Math.max(0, (water || 0) + n);
        setWater(nw);
        const nd = { ...data, water: nw };
        const cleanData = JSON.parse(JSON.stringify(nd));
        setData(cleanData);
        await save(cleanData);
      }

      function genNew() {
        const currentWorkoutType = manualWorkoutType || workout.type;
        if (!workout || currentWorkoutType === 'running') return;
        const vars = exercises[currentWorkoutType] || [];
        setWorkout({ ...workout, var: (workout.var + 1) % Math.max(1, vars.length) });
      }

      // Knowledge Integration Functions
      function generateTodaysApplication() {
        const books = [
          {
            title: "Atomic Habits",
            author: "James Clear",
            application: "Today, identify one habit you want to build and start with a 2-minute version. For example, if you want to read more, commit to reading just one page after breakfast."
          },
          {
            title: "The Power of Habit",
            author: "Charles Duhigg",
            application: "Today, identify your habit loop: pick a cue, routine, and reward for one habit you want to change. Replace the routine while keeping the same cue and reward."
          },
          {
            title: "How to Win Friends",
            author: "Dale Carnegie",
            application: "Today, practice the principle of appreciation: find three people to genuinely compliment or thank before noon. Notice how it affects your interactions."
          },
          {
            title: "Thinking, Fast and Slow",
            author: "Daniel Kahneman",
            application: "Today, catch yourself in 'fast thinking' mode when making a decision. Pause and consciously switch to 'slow thinking' by asking: What information am I missing?"
          },
          {
            title: "The 7 Habits",
            author: "Stephen Covey",
            application: "Today, practice 'begin with the end in mind': Before starting your first task, visualize what success looks like and work backwards from there."
          },
          {
            title: "Deep Work",
            author: "Cal Newport",
            application: "Today, schedule your most important deep work session during your peak energy time. Protect this time fiercely - no email, no notifications."
          },
          {
            title: "The Life-Changing Magic",
            author: "Marie Kondo",
            application: "Today, apply the 'spark joy' test to your digital life: delete 10 apps, unsubscribe from 5 newsletters, and organize one digital folder that sparks confusion."
          },
          {
            title: "Sapiens",
            author: "Yuval Noah Harari",
            application: "Today, question a cultural norm: Pick one societal 'truth' you follow automatically and ask yourself why you believe it. Is it serving you?"
          },
          {
            title: "The Body Keeps Score",
            author: "Bessel van der Kolk",
            application: "Today, practice body awareness: Throughout the day, notice physical sensations in your body. When you feel tension, take 3 deep breaths and relax that area."
          },
          {
            title: "Meditations",
            author: "Marcus Aurelius",
            application: "Today, practice Stoic acceptance: When something doesn't go your way, remind yourself 'This was not in my control' and focus on your response instead."
          }
        ];

        const today = new Date();
        const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
        const bookIndex = dayOfYear % books.length;
        setCurrentBookApplication(books[bookIndex]);
      }

      function addToKnowledgeBase(note) {
        const newEntry = {
          id: Date.now(),
          content: note.content,
          source: note.source,
          category: note.category,
          dateAdded: new Date().toISOString(),
          tags: note.tags || []
        };

        const updatedKnowledge = [newEntry, ...knowledgeBase];
        setKnowledgeBase(updatedKnowledge);
        localStorage.setItem('vita-knowledge-base', JSON.stringify(updatedKnowledge));
      }

      function addToSpacedRepetition(item) {
        const newItem = {
          id: Date.now(),
          content: item.content,
          source: item.source,
          interval: 1, // days
          nextReview: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // tomorrow
          easeFactor: 2.5, // SuperMemo default
          repetitions: 0,
          lastReviewed: new Date().toISOString()
        };

        const updatedRepetition = [...spacedRepetition, newItem];
        setSpacedRepetition(updatedRepetition);
        localStorage.setItem('vita-spaced-repetition', JSON.stringify(updatedRepetition));
      }

      function saveReadingProgress(entry) {
        const today = new Date().toDateString();
        const now = new Date();
        const isNewReadingDay = readingProgress.lastReadingDate !== today;

        // Create new reading entry
        const newEntry = {
          id: Date.now(),
          date: now.toISOString(),
          bookTitle: entry.bookTitle || 'Untitled',
          pagesRead: parseInt(entry.pagesRead || 0),
          insights: entry.insights || '',
          notes: entry.notes || ''
        };

        // Update reading history
        const updatedHistory = [newEntry, ...readingHistory];
        setReadingHistory(updatedHistory);
        localStorage.setItem('vita-reading-history', JSON.stringify(updatedHistory));

        // Update reading progress stats
        const updatedProgress = {
          ...readingProgress,
          pagesRead: readingProgress.pagesRead + parseInt(entry.pagesRead || 0),
          insightsGained: readingProgress.insightsGained + (entry.insights ? 1 : 0),
          currentStreak: isNewReadingDay ? readingProgress.currentStreak + 1 : readingProgress.currentStreak,
          longestStreak: Math.max(readingProgress.longestStreak, readingProgress.currentStreak + (isNewReadingDay ? 1 : 0)),
          lastReadingDate: today
        };

        setReadingProgress(updatedProgress);
        localStorage.setItem('vita-reading-progress', JSON.stringify(updatedProgress));
        setReadingEntry({ bookTitle: '', pagesRead: '', insights: '', notes: '' });
        setShowReadingModal(false);
        setSaveStatus('üìö Reading progress saved!');
        setTimeout(() => setSaveStatus(''), 3000);
      }

      function reviewSpacedItem(itemId, quality) {
        // SuperMemo-2 algorithm for spaced repetition
        const item = spacedRepetition.find(i => i.id === itemId);
        if (!item) return;

        let newInterval, newEaseFactor;

        if (quality >= 3) { // Correct response
          if (item.repetitions === 0) {
            newInterval = 1;
          } else if (item.repetitions === 1) {
            newInterval = 6;
          } else {
            newInterval = Math.round(item.interval * item.easeFactor);
          }

          newEaseFactor = item.easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
        } else { // Incorrect response
          newInterval = 1;
          newEaseFactor = item.easeFactor;
        }

        newEaseFactor = Math.max(1.3, newEaseFactor);

        const updatedItem = {
          ...item,
          interval: newInterval,
          easeFactor: newEaseFactor,
          repetitions: quality >= 3 ? item.repetitions + 1 : 0,
          nextReview: new Date(Date.now() + newInterval * 24 * 60 * 60 * 1000).toISOString(),
          lastReviewed: new Date().toISOString()
        };

        const updatedRepetition = spacedRepetition.map(i =>
          i.id === itemId ? updatedItem : i
        ).filter(i => new Date(i.nextReview) > new Date()); // Remove completed items

        setSpacedRepetition(updatedRepetition);
        localStorage.setItem('vita-spaced-repetition', JSON.stringify(updatedRepetition));
      }

      // Challenge Management Functions
      function createChallenge(challengeData) {
        const newChallenge = {
          id: Date.now(),
          title: challengeData.title,
          description: challengeData.description,
          duration: challengeData.duration,
          category: challengeData.category,
          type: challengeData.type, // 'habit', 'avoid', 'track'
          target: challengeData.target,
          unit: challengeData.unit,
          reward: challengeData.reward,
          createdAt: new Date().toISOString(),
          startDate: new Date().toISOString(),
          completed: false,
          progress: [],
          currentStreak: 0,
          bestStreak: 0
        };

        const updatedChallenges = [...challenges, newChallenge];
        setChallenges(updatedChallenges);
        localStorage.setItem('vita-challenges', JSON.stringify([...updatedChallenges, ...completedChallenges]));
      }

      function updateChallengeProgress(challengeId, completed) {
        const challenge = challenges.find(c => c.id === challengeId);
        if (!challenge) return;

        const today = new Date().toISOString().split('T')[0];
        const existingProgress = challenge.progress.find(p => p.date === today);

        let newProgress;
        if (existingProgress) {
          newProgress = challenge.progress.map(p =>
            p.date === today ? { ...p, completed } : p
          );
        } else {
          newProgress = [...challenge.progress, { date: today, completed }];
        }

        // Calculate streaks
        const sortedProgress = newProgress.sort((a, b) => new Date(b.date) - new Date(a.date));
        let currentStreak = 0;
        let bestStreak = challenge.bestStreak;

        for (const day of sortedProgress) {
          if (day.completed) {
            currentStreak++;
          } else {
            break;
          }
        }

        bestStreak = Math.max(bestStreak, currentStreak);

        const updatedChallenge = {
          ...challenge,
          progress: newProgress,
          currentStreak,
          bestStreak
        };

        // Check if challenge is completed
        const challengeEndDate = new Date(challenge.startDate);
        challengeEndDate.setDate(challengeEndDate.getDate() + challenge.duration);

        if (new Date() >= challengeEndDate && currentStreak >= Math.ceil(challenge.duration * 0.8)) {
          // Challenge completed successfully
          updatedChallenge.completed = true;
          updatedChallenge.completedAt = new Date().toISOString();

          // Award badge
          awardBadge({
            name: `${challenge.title} Champion`,
            description: `Completed ${challenge.duration}-day ${challenge.category} challenge`,
            icon: getBadgeIcon(challenge.category),
            earnedAt: new Date().toISOString(),
            challengeId: challenge.id
          });

          setCompletedChallenges(prev => [...prev, updatedChallenge]);
          setChallenges(prev => prev.filter(c => c.id !== challengeId));
        } else {
          setChallenges(prev => prev.map(c => c.id === challengeId ? updatedChallenge : c));
        }

        localStorage.setItem('vita-challenges', JSON.stringify([...challenges.filter(c => c.id !== challengeId).map(c => c.id === challengeId ? updatedChallenge : c), ...completedChallenges]));
      }

      function awardBadge(badge) {
        const newBadges = [...badges, badge];
        setBadges(newBadges);
        localStorage.setItem('vita-badges', JSON.stringify(newBadges));
      }

      function getBadgeIcon(category) {
        const icons = {
          fitness: 'üí™',
          discipline: 'üéØ',
          nutrition: 'ü•ó',
          reading: 'üìö',
          mindfulness: 'üßò',
          sleep: 'üò¥',
          productivity: 'üöÄ',
          social: 'ü§ù'
        };
        return icons[category] || 'üèÜ';
      }

      function getSuggestedChallenges() {
        return [
          {
            title: "7-Day Discipline Challenge",
            description: "Complete all daily tasks for 7 consecutive days",
            duration: 7,
            category: 'discipline',
            type: 'habit',
            target: 1,
            unit: 'days',
            reward: 'Consistency Badge'
          },
          {
            title: "30-Day Fitness Challenge",
            description: "Complete a workout every day for 30 days",
            duration: 30,
            category: 'fitness',
            type: 'habit',
            target: 1,
            unit: 'workouts',
            reward: 'Fitness Champion Badge'
          },
          {
            title: "No Sugar for 10 Days",
            description: "Avoid all added sugars for 10 consecutive days",
            duration: 10,
            category: 'nutrition',
            type: 'avoid',
            target: 0,
            unit: 'sugar items',
            reward: 'Sugar-Free Badge'
          },
          {
            title: "Read 10 Minutes Daily for 14 Days",
            description: "Read for at least 10 minutes every day",
            duration: 14,
            category: 'reading',
            type: 'habit',
            target: 10,
            unit: 'minutes',
            reward: 'Reading Habit Badge'
          },
          {
            title: "Mindful Morning Routine",
            description: "Practice 10 minutes of mindfulness or meditation daily",
            duration: 21,
            category: 'mindfulness',
            type: 'habit',
            target: 10,
            unit: 'minutes',
            reward: 'Mindfulness Master Badge'
          },
          {
            title: "Sleep Champion",
            description: "Get 7+ hours of sleep every night",
            duration: 14,
            category: 'sleep',
            type: 'habit',
            target: 7,
            unit: 'hours',
            reward: 'Sleep Champion Badge'
          }
        ];
      }

      // AI Life Coach Functions
      function generateAICoachInsights() {
        if (history.length < 3) {
          return {
            dailyFocus: "Keep tracking your activities to receive personalized coaching insights.",
            weeklyReview: "Not enough data yet for weekly analysis.",
            monthlyReflection: "Continue building your data for monthly reflections.",
            personalizedSuggestions: [],
            patternInsights: [],
            priorityActions: []
          };
        }

        // Analyze daily focus based on current patterns
        const today = new Date();
        const dayOfWeek = today.toLocaleDateString('en-US', { weekday: 'long' });
        const recentWeek = history.slice(-7);

        // Daily focus analysis
        let dailyFocus = "";

        // Check for concerning patterns
        const avgTasks = recentWeek.reduce((sum, d) => sum + (d.done ? d.done.length : 0), 0) / recentWeek.length;
        const avgMood = recentWeek.filter(d => d.mood).length / recentWeek.length;
        const workoutStreak = recentWeek.filter(d => d.workoutDone).length;

        if (avgTasks < 10) {
          dailyFocus = "Focus on building momentum with small, consistent actions. Start with your most important 3 tasks today.";
        } else if (workoutStreak < 3) {
          dailyFocus = "Your body thrives on movement. Schedule a workout today - even 20 minutes makes a difference.";
        } else if (avgMood < 0.7) {
          dailyFocus = "Prioritize emotional wellbeing today. Consider a walk in nature or connecting with someone meaningful.";
        } else {
          dailyFocus = "You're on a strong trajectory! Today, focus on deepening one key habit or relationship.";
        }

        // Weekly review analysis
        const weeklyStats = {
          totalTasks: recentWeek.reduce((sum, d) => sum + (d.done ? d.done.length : 0), 0),
          workoutsCompleted: recentWeek.filter(d => d.workoutDone).length,
          avgMoodScore: recentWeek.filter(d => d.mood).map(d => {
            const scores = { 'üòä Sharp': 5, 'üôÇ Good': 4, 'üòê Okay': 3, 'üòî Off': 2, 'üò∞ Hard': 1 };
            return scores[d.mood] || 3;
          }).reduce((a, b) => a + b, 0) / Math.max(1, recentWeek.filter(d => d.mood).length),
          readingDays: recentWeek.filter(d => d.done && d.done.some(task => task.includes('read'))).length,
          socialDays: recentWeek.filter(d => d.done && d.done.some(task => task.includes('connect') || task.includes('social'))).length
        };

        let weeklyReview = `This week you completed ${weeklyStats.totalTasks} tasks and ${weeklyStats.workoutsCompleted} workouts. `;

        if (weeklyStats.avgMoodScore >= 4) {
          weeklyReview += "Your emotional wellbeing has been strong. ";
        } else if (weeklyStats.avgMoodScore >= 3) {
          weeklyReview += "Your mood has been stable but could use some attention. ";
        } else {
          weeklyReview += "Your emotional state needs nurturing. ";
        }

        if (weeklyStats.readingDays >= 4) {
          weeklyReview += "Excellent reading consistency! ";
        } else if (weeklyStats.readingDays >= 2) {
          weeklyReview += "Good reading habits developing. ";
        } else {
          weeklyReview += "Consider building a daily reading ritual. ";
        }

        weeklyReview += "Next week, focus on sustaining your strongest habits while gently improving areas of opportunity.";

        // Monthly reflection (based on last 30 days)
        const monthlyData = history.slice(-30);
        let monthlyReflection = "";

        if (monthlyData.length >= 30) {
          const monthlyStats = {
            avgDailyTasks: monthlyData.reduce((sum, d) => sum + (d.done ? d.done.length : 0), 0) / 30,
            workoutConsistency: monthlyData.filter(d => d.workoutDone).length / 30,
            moodConsistency: monthlyData.filter(d => d.mood).length / 30,
            bestStreak: (() => {
              let currentStreak = 0;
              let maxStreak = 0;
              for (const day of monthlyData) {
                if (day.done && day.done.length > 0) {
                  currentStreak++;
                  maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                  currentStreak = 0;
                }
              }
              return maxStreak;
            })()
          };

          monthlyReflection = `This month, you've shown remarkable ${monthlyStats.workoutConsistency > 0.7 ? 'physical' : monthlyStats.avgDailyTasks > 15 ? 'productive' : 'personal'} consistency. `;

          if (monthlyStats.bestStreak > 10) {
            monthlyReflection += `Your ${monthlyStats.bestStreak}-day streak demonstrates incredible discipline. `;
          }

          monthlyReflection += "Reflect on what systems and mindsets made this possible, and consider how to apply these insights to new areas of growth.";
        } else {
          monthlyReflection = "Continue building your data foundation. Monthly reflections become most valuable after consistent tracking for several weeks.";
        }

        // Personalized suggestions based on patterns
        const personalizedSuggestions = [];

        // Analyze productivity patterns
        const productivityByDay = {};
        recentWeek.forEach(day => {
          const dayName = new Date(day.date).toLocaleDateString('en-US', { weekday: 'short' });
          productivityByDay[dayName] = (productivityByDay[dayName] || 0) + (day.done ? day.done.length : 0);
        });

        const mostProductiveDay = Object.entries(productivityByDay).sort(([,a], [,b]) => b - a)[0]?.[0];
        if (mostProductiveDay) {
          personalizedSuggestions.push({
            type: 'productivity',
            title: 'Optimize Your Schedule',
            suggestion: `Schedule important work for ${mostProductiveDay}s when you're naturally most productive.`,
            icon: 'üìÖ'
          });
        }

        // Energy pattern analysis
        const energyPatterns = recentWeek.filter(d => d.energyLevel);
        if (energyPatterns.length >= 3) {
          const highEnergyDays = energyPatterns.filter(d => d.energyLevel === 'high').length;
          const lowEnergyDays = energyPatterns.filter(d => d.energyLevel === 'low' || d.energyLevel === 'exhausted').length;

          if (highEnergyDays > lowEnergyDays) {
            personalizedSuggestions.push({
              type: 'energy',
              title: 'Leverage Peak Energy',
              suggestion: 'Use your high-energy periods for challenging tasks and creative work.',
              icon: '‚ö°'
            });
          } else {
            personalizedSuggestions.push({
              type: 'energy',
              title: 'Energy Management',
              suggestion: 'Focus on sleep, nutrition, and recovery to improve baseline energy levels.',
              icon: 'üîã'
            });
          }
        }

        // Social connection analysis
        const socialPatterns = recentWeek.filter(d => d.done && d.done.some(task =>
          task.includes('connect') || task.includes('social') || task.includes('friend')
        ));

        if (socialPatterns.length < 2) {
          personalizedSuggestions.push({
            type: 'social',
            title: 'Build Social Connections',
            suggestion: 'Schedule regular social interactions - they\'re crucial for emotional wellbeing.',
            icon: 'ü§ù'
          });
        }

        // Reading habit analysis
        const readingPatterns = recentWeek.filter(d => d.done && d.done.some(task => task.includes('read')));

        if (readingPatterns.length >= 5) {
          personalizedSuggestions.push({
            type: 'growth',
            title: 'Deepen Reading Practice',
            suggestion: 'Consider joining a book club or starting a reading journal to enhance comprehension.',
            icon: 'üìö'
          });
        } else if (readingPatterns.length < 2) {
          personalizedSuggestions.push({
            type: 'growth',
            title: 'Cultivate Reading Habit',
            suggestion: 'Start with 10 minutes daily. Reading compounds knowledge exponentially.',
            icon: 'üìñ'
          });
        }

        // Pattern insights
        const patternInsights = [];

        // Workout-mood correlation
        const workoutMoodData = recentWeek.filter(d => d.mood && d.workoutDone !== undefined);
        if (workoutMoodData.length >= 4) {
          const workoutDaysMood = workoutMoodData.filter(d => d.workoutDone).map(d => {
            const scores = { 'üòä Sharp': 5, 'üôÇ Good': 4, 'üòê Okay': 3, 'üòî Off': 2, 'üò∞ Hard': 1 };
            return scores[d.mood] || 3;
          }).reduce((a, b) => a + b, 0) / workoutMoodData.filter(d => d.workoutDone).length;

          const nonWorkoutDaysMood = workoutMoodData.filter(d => !d.workoutDone).map(d => {
            const scores = { 'üòä Sharp': 5, 'üôÇ Good': 4, 'üòê Okay': 3, 'üòî Off': 2, 'üò∞ Hard': 1 };
            return scores[d.mood] || 3;
          }).reduce((a, b) => a + b, 0) / Math.max(1, workoutMoodData.filter(d => !d.workoutDone).length);

          if (workoutDaysMood > nonWorkoutDaysMood + 0.5) {
            patternInsights.push({
              title: 'Movement Boosts Mood',
              insight: 'Your workouts correlate with improved emotional state. Exercise could be your natural mood enhancer.',
              impact: 'High'
            });
          }
        }

        // Priority actions based on current state
        const priorityActions = [];

        // Check for immediate needs
        const todayData = history[history.length - 1];
        if (todayData) {
          if (!todayData.mood) {
            priorityActions.push({
              action: 'Set your mood for today',
              reason: 'Mood tracking helps identify patterns and improve emotional awareness',
              urgency: 'medium'
            });
          }

          if (!todayData.workoutDone && workoutStreak >= 3) {
            priorityActions.push({
              action: 'Complete today\'s workout',
              reason: 'You\'re on a workout streak - don\'t break the momentum!',
              urgency: 'high'
            });
          }

          if ((todayData.done ? todayData.done.length : 0) < 5) {
            priorityActions.push({
              action: 'Focus on high-impact tasks',
              reason: 'Starting your day with key accomplishments builds momentum',
              urgency: 'medium'
            });
          }
        }

        return {
          dailyFocus,
          weeklyReview,
          monthlyReflection,
          personalizedSuggestions,
          patternInsights,
          priorityActions
        };
      }

      if (loading || !data || !workout) {
        return (
          <div className="flex items-center justify-center h-screen">
            <div className="text-xl text-gray-300">Loading‚Ä¶</div>
          </div>
        );
      }


      if (view === 'workouts') {
        const currentWorkoutType = manualWorkoutType || workout.type;
        const ex = currentWorkoutType === 'running' ? null : exercises[currentWorkoutType][workout.var];
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
            <div className="max-w-4xl mx-auto p-4 space-y-6">
              {/* Beautiful Header */}
              <div className="relative overflow-hidden bg-gradient-to-r from-green-900/40 via-emerald-900/40 to-teal-900/40 rounded-2xl p-8 border border-green-700/30 backdrop-blur-sm">
                <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wMyI+PHBhdGggZD0iTTM2IDM0djItSDI0di0yaDEyek0zNiAyNHYySDE0di0yaDIyek0zNiAxNHYySDE0di0yaDIyeiIvPjwvZz48L2c+PC9zdmc+')] opacity-50"></div>
                <div className="relative">
                  <h1 className="text-4xl font-black bg-gradient-to-r from-green-200 via-emerald-200 to-teal-200 bg-clip-text text-transparent tracking-tight text-center">
                    Workout Tracker
                  </h1>
                  <p className="text-green-200/70 mt-1 text-center text-sm">Strength, consistency, progress</p>
                </div>
              </div>

              {/* Modern Navigation */}
              <div className="flex gap-2 justify-center flex-wrap">
                <button onClick={() => setView('today')} className="group relative px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50">
                  <span className="flex items-center gap-2">
                    <span className="text-lg">üè†</span>
                    Today
                  </span>
                </button>
                <button onClick={() => setView('progress')} className="group relative px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50">
                  <span className="flex items-center gap-2">
                    <span className="text-lg">üìä</span>
                    Progress
                  </span>
                </button>
                <button onClick={() => setView('workouts')} className="group relative px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-green-500/25 transition-all duration-300">
                  <span className="flex items-center gap-2">
                    <span className="text-lg">üí™</span>
                    Workouts
                  </span>
                </button>
                <button onClick={() => setView('life-tracker')} className="group relative px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50">
                  <span className="flex items-center gap-2">
                    <span className="text-lg">üìÖ</span>
                    Life Tracker
                  </span>
                </button>
              </div>

              {/* Current Workout */}
              <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-6 border border-slate-700/50">
                <div className="flex items-center gap-3 mb-4">
                  <span className="text-3xl">üèãÔ∏è</span>
                  <div>
                    <h3 className="text-xl font-bold text-green-400">Today's Workout</h3>
                    <p className="text-sm text-gray-400 capitalize">{currentWorkoutType.replace('-', ' ')}</p>
                  </div>
                </div>

                {currentWorkoutType === 'running' ? (
                  <div className="text-center py-8">
                    <div className="text-6xl mb-4">üèÉ</div>
                    <p className="text-gray-400">Running day! Go for a run or cardio activity.</p>
                    <button
                      onClick={completeWorkout}
                      className="mt-4 px-6 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold transition-colors"
                    >
                      Complete Run
                    </button>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {ex && ex.map((exercise, idx) => (
                      <div key={idx} className="bg-slate-700/30 rounded-xl p-4 border border-slate-600/30">
                        <div className="flex items-center justify-between mb-2">
                          <span className="font-semibold text-white">{exercise}</span>
                          <span className="text-sm text-gray-400">Set {idx + 1}</span>
                        </div>
                        <div className="flex gap-2">
                          <input
                            type="number"
                            placeholder="lbs"
                            className="flex-1 px-3 py-2 bg-slate-600/50 border border-slate-500 rounded-lg text-white placeholder-gray-400 text-sm"
                            value={weights[`${currentWorkoutType}-${workout.var}-${idx}`] || ''}
                            onChange={(e) => {
                              const newWeights = {...weights, [`${currentWorkoutType}-${workout.var}-${idx}`]: e.target.value};
                              setWeights(newWeights);
                            }}
                          />
                        </div>
                      </div>
                    ))}

                    <div className="flex gap-3 pt-4">
                      <button
                        onClick={() => setWorkout({...workout, var: (workout.var + 1) % Math.max(1, exercises[currentWorkoutType]?.length || 1)})}
                        className="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-medium transition-colors"
                      >
                        Next Variation
                      </button>
                      <button
                        onClick={completeWorkout}
                        className="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 text-white rounded-xl font-bold shadow-lg transition-all"
                      >
                        Complete Workout
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      if (view === 'progress') {
        const rate = history.length > 0 ? Math.round((history.reduce((s, d) => s + d.done.length, 0) / (history.length * 18)) * 100) : 0;
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
            <div className="max-w-4xl mx-auto p-4 space-y-6">
              {/* Beautiful Header */}
              <div className="relative overflow-hidden bg-gradient-to-r from-blue-900/40 via-indigo-900/40 to-purple-900/40 rounded-2xl p-8 border border-blue-700/30 backdrop-blur-sm">
                <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wMyI+PHBhdGggZD0iTTM2IDM0djItSDI0di0yaDEyek0zNiAyNHYySDE0di0yaDIyek0zNiAxNHYySDE0di0yaDIyeiIvPjwvZz48L2c+PC9zdmc+')] opacity-50"></div>
                <div className="relative">
                  <h1 className="text-4xl font-black bg-gradient-to-r from-blue-200 via-indigo-200 to-purple-200 bg-clip-text text-transparent tracking-tight text-center">
                    Progress Dashboard
                  </h1>
                  <p className="text-blue-200/70 mt-1 text-center text-sm">Your journey visualized</p>
                </div>
              </div>

              {/* Modern Navigation */}
              <div className="flex gap-2 justify-center flex-wrap">
                <button onClick={() => setView('today')} className="group relative px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50">
                  <span className="flex items-center gap-2">
                    <span className="text-lg">üè†</span>
                    Today
                  </span>
                </button>
                <button onClick={() => setView('progress')} className="group relative px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl font-bold shadow-lg shadow-blue-500/25 transition-all duration-300">
                  <span className="flex items-center gap-2">
                    <span className="text-lg">üìä</span>
                    Progress
                  </span>
                </button>
                <button onClick={() => setView('workouts')} className="group relative px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50">
                  <span className="flex items-center gap-2">
                    <span className="text-lg">üí™</span>
                    Workouts
                  </span>
                </button>
                <button onClick={() => setView('life-tracker')} className="group relative px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50">
                  <span className="flex items-center gap-2">
                    <span className="text-lg">üìÖ</span>
                    Life Tracker
                  </span>
                </button>
              </div>
              {/* Key Metrics Grid */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700/50 text-center">
                  <div className="text-3xl font-bold text-blue-400 mb-2">{rate}%</div>
                  <div className="text-sm text-gray-400 mb-1">Completion Rate</div>
                  <div className="text-xs text-gray-500">avg across all days</div>
                </div>

                <div className="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700/50 text-center">
                  <div className="text-3xl font-bold text-green-400 mb-2">{history.length}</div>
                  <div className="text-sm text-gray-400 mb-1">Days Tracked</div>
                  <div className="text-xs text-gray-500">total journey</div>
                </div>

                <div className="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700/50 text-center">
                  <div className="text-3xl font-bold text-purple-400 mb-2">{history.filter(d => d.workoutDone).length}</div>
                  <div className="text-sm text-gray-400 mb-1">Workouts</div>
                  <div className="text-xs text-gray-500">completed</div>
                </div>

                <div className="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700/50 text-center">
                  <div className="text-3xl font-bold text-amber-400 mb-2">{history.slice(0, 7).filter(d => d.done.length > 0).length}</div>
                  <div className="text-sm text-gray-400 mb-1">This Week</div>
                  <div className="text-xs text-gray-500">active days</div>
                </div>
              </div>

              {history.length > 7 && (
                <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-6 border border-slate-700/50">
                  <div className="flex items-center gap-3 mb-6">
                    <span className="text-3xl">üìà</span>
                    <div>
                      <h2 className="text-xl font-bold text-blue-400">Monthly Trends</h2>
                      <p className="text-sm text-gray-400">Your progress over time</p>
                    </div>
                  </div>
                  <div className="space-y-3 max-h-64 overflow-y-auto">
                    {(() => {
                      const months = {};
                      history.forEach(day => {
                        const date = new Date(day.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (!months[monthKey]) months[monthKey] = { days: 0, tasks: 0, workouts: 0 };
                        months[monthKey].days++;
                        months[monthKey].tasks += day.done.length;
                        if (day.workoutDone) months[monthKey].workouts++;
                      });

                      return Object.entries(months)
                        .sort(([a], [b]) => b.localeCompare(a))
                        .slice(0, 6)
                        .map(([month, stats]) => ({
                          month: new Date(month + '-01').toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                          avgTasks: Math.round((stats.tasks / stats.days) || 0),
                          workoutRate: Math.round((stats.workouts / stats.days) * 100) || 0
                        }))
                        .map(stat => (
                          <div key={stat.month} className="flex justify-between items-center bg-slate-700 rounded p-2">
                            <span className="font-medium">{stat.month}</span>
                            <div className="flex gap-4 text-sm">
                              <span>Tasks: <span className="text-amber-400">{stat.avgTasks}/18</span></span>
                              <span>Workouts: <span className="text-green-400">{stat.workoutRate}%</span></span>
                            </div>
                          </div>
                        ));
                    })()}
                  </div>
                </div>
              )}

              {/* History Section */}
              <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-6 border border-slate-700/50">
                <div className="flex justify-between items-center mb-6">
                  <div className="flex items-center gap-3">
                    <span className="text-3xl">üìö</span>
                    <div>
                      <h2 className="text-xl font-bold text-indigo-400">
                        {showAllHistory ? `All History (${history.length} days)` : 'Recent Activity'}
                      </h2>
                      <p className="text-sm text-gray-400">Your journey day by day</p>
                    </div>
                  </div>
                  {history.length > 7 && (
                    <button
                      onClick={() => setShowAllHistory(!showAllHistory)}
                      className="px-4 py-2 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl text-sm font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50"
                    >
                      {showAllHistory ? 'Show Recent' : `View All (${history.length})`}
                    </button>
                  )}
                </div>
                {(showAllHistory ? history : history.slice(0, 7)).map(d => {
                  const pct = Math.round((d.done.length / 18) * 100);
                  const daysAgo = Math.floor((new Date() - new Date(d.date)) / (1000 * 60 * 60 * 24));
                  const isToday = daysAgo === 0;
                  const isYesterday = daysAgo === 1;

                  return (
                    <div key={d.date} className="bg-slate-700 rounded-lg p-4 mb-3 cursor-pointer hover:bg-slate-600 transition-colors" onClick={() => setViewingDay(d)}>
                      <div className="flex justify-between mb-2">
                        <div className="flex items-center gap-2">
                          <span className="font-medium">
                            {isToday ? 'Today' :
                             isYesterday ? 'Yesterday' :
                             new Date(d.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                          </span>
                          {daysAgo > 1 && <span className="text-xs text-gray-500">({daysAgo} days ago)</span>}
                      </div>
                        <div className="flex items-center gap-2">
                          {d.workoutDone && <span className="text-green-400 text-sm">üí™</span>}
                          <span className="text-amber-400 font-bold">{pct}%</span>
                        </div>
                      </div>
                      <div className="w-full bg-slate-600 rounded-full h-2 mb-2">
                        <div className="bg-amber-500 h-2 rounded-full" style={{ width: `${pct}%` }} />
                      </div>
                      <div className="text-xs text-gray-400">
                        {d.done.length}/18 tasks ‚Ä¢ {d.workoutDone ? `Workout: ${d.workoutType || 'Completed'}` : 'No workout'}
                        {d.journal && <span className="ml-2">üìù</span>}
                      </div>
                    </div>
                  );
                })}
                {history.length === 0 && (
                  <div className="text-center py-8 text-gray-500">
                    <p className="text-lg mb-2">No history yet</p>
                    <p className="text-sm">Complete some tasks and they'll appear here!</p>
              </div>
                )}
              </div>

              {viewingDay && (
                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold">
                      {new Date(viewingDay.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                    </h2>
                    <button onClick={() => setViewingDay(null)} className="px-3 py-1 bg-slate-700 rounded text-sm hover:bg-slate-600">‚úï</button>
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-6">
                    <div className="bg-slate-700 rounded-lg p-4">
                      <p className="text-sm text-gray-400 mb-1">Tasks Completed</p>
                      <p className="text-2xl font-bold text-amber-400">{viewingDay.done.length}/18</p>
                      <p className="text-sm text-gray-300">{Math.round((viewingDay.done.length / 18) * 100)}% complete</p>
                    </div>
                    <div className="bg-slate-700 rounded-lg p-4">
                      <p className="text-sm text-gray-400 mb-1">Workout</p>
                      <p className="text-lg font-bold text-green-400">
                        {viewingDay.workoutDone ? (viewingDay.workoutType ? labels[viewingDay.workoutType] || viewingDay.workoutType : 'Completed') : 'Not completed'}
                      </p>
                      {viewingDay.miles && <p className="text-sm text-gray-300">{viewingDay.miles} miles run</p>}

                      {viewingDay.workoutDone && viewingDay.workoutExercises && viewingDay.workoutExercises.length > 0 && (
                        <div className="mt-3">
                          <p className="text-xs text-gray-400 mb-2">Exercises Completed:</p>
                          <div className="space-y-2">
                            {viewingDay.workoutExercises.map((exercise, idx) => {
                              const exerciseWeights = viewingDay.weights[exercise];
                              return (
                                <div key={idx} className="text-sm">
                                  <div className="text-gray-300 mb-1">{exercise}</div>
                                  {exerciseWeights && (
                                    <div className="ml-2 text-xs text-amber-400">
                                      {Array.isArray(exerciseWeights)
                                        ? exerciseWeights.map((weight, setIdx) => `${weight} lbs`).join(', ')
                                        : `${exerciseWeights} lbs`
                                      }
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="mb-6">
                    <h3 className="font-bold mb-3">Completed Tasks</h3>
                    <div className="space-y-2">
                      {tasks.core.map(t => (
                        <div key={t.id} className={`p-2 rounded text-sm ${viewingDay.done.includes(t.id) ? 'bg-green-900 border border-green-600' : 'bg-slate-700 opacity-50'}`}>
                          <span>{viewingDay.done.includes(t.id) ? '‚úÖ' : '‚¨ú'}</span> {t.t}
                        </div>
                      ))}
                      {tasks.lead.map(t => (
                        <div key={t.id} className={`p-2 rounded text-sm ${viewingDay.done.includes(t.id) ? 'bg-amber-900 border border-amber-600' : 'bg-slate-700 opacity-50'}`}>
                          <span>{viewingDay.done.includes(t.id) ? '‚úÖ' : '‚¨ú'}</span> {t.t}
                        </div>
                      ))}
                      {tasks.comm.map(t => (
                        <div key={t.id} className={`p-2 rounded text-sm ${viewingDay.done.includes(t.id) ? 'bg-purple-900 border border-purple-600' : 'bg-slate-700 opacity-50'}`}>
                          <span>{viewingDay.done.includes(t.id) ? '‚úÖ' : '‚¨ú'}</span> {t.t}
                        </div>
                      ))}
                    </div>
                  </div>


                  {viewingDay.journal && (
                    <div className="mb-4">
                      <h3 className="font-bold mb-2">Reflection</h3>
                      <div className="bg-slate-700 rounded p-3 text-sm text-gray-300">
                        {viewingDay.journal}
                      </div>
                    </div>
                  )}

                  {/* SaaS Work Section */}
                  {(viewingDay.saas || viewingDay.deepWork || viewingDay.talks) && (
                    <div className="mb-4">
                      <h3 className="font-bold mb-2">üíº SaaS Work</h3>
                      <div className="bg-slate-700 rounded p-3 text-sm">
                        {viewingDay.saas && (
                          <div className="mb-2">
                            <span className="text-gray-400">What I worked on:</span>
                            <div className="text-gray-300 mt-1">{viewingDay.saas}</div>
                          </div>
                        )}
                        <div className="grid grid-cols-2 gap-4 mt-3">
                          {viewingDay.deepWork && (
                            <div>
                              <span className="text-gray-400">Deep Work Hours:</span>
                              <div className="text-amber-400 font-medium">{viewingDay.deepWork} hrs</div>
                            </div>
                          )}
                          {viewingDay.talks && (
                            <div>
                              <span className="text-gray-400">User Talks:</span>
                              <div className="text-blue-400 font-medium">{viewingDay.talks}</div>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Nutrition Section */}
                  {viewingDay.nutritionData && (
                    <div className="mb-4">
                      <h3 className="font-bold mb-2">ü•ó Nutrition</h3>
                      <div className="bg-slate-700 rounded p-3 text-sm">
                        {Object.keys(viewingDay.nutritionData).length > 0 ? (
                          <div className="space-y-2">
                            {Object.entries(viewingDay.nutritionData).map(([meal, items]) => (
                              <div key={meal} className="border-b border-slate-600 pb-2">
                                <div className="font-medium text-amber-400 capitalize mb-1">{meal}:</div>
                                <div className="text-gray-300 text-xs space-y-1">
                                  {items.map((item, idx) => (
                                    <div key={idx} className="flex justify-between">
                                      <span>{item.name}</span>
                                      <span>{item.calories} cal</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <div className="text-gray-400">No nutrition data recorded</div>
                        )}
                      </div>
                    </div>
                  )}

                  <div className="grid grid-cols-3 gap-4 text-center">
                    {viewingDay.mood && (
                      <div className="bg-slate-700 rounded p-3">
                        <p className="text-xs text-gray-400 mb-1">Mood</p>
                        <p className="text-lg">{viewingDay.mood}</p>
                      </div>
                    )}
                    {viewingDay.water && (
                      <div className="bg-slate-700 rounded p-3">
                        <p className="text-xs text-gray-400 mb-1">Water</p>
                        <p className="text-lg">{viewingDay.water} glasses</p>
                      </div>
                    )}
                    {viewingDay.deepWork && (
                      <div className="bg-slate-700 rounded p-3">
                        <p className="text-xs text-gray-400 mb-1">Deep Work</p>
                        <p className="text-lg">{viewingDay.deepWork} hrs</p>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      if (view === 'data') {
        // Data integrity check
        validateDataIntegrity();

        // Check last backup
        const lastBackup = localStorage.getItem('vita-last-backup');
        const daysSinceBackup = lastBackup ?
          Math.floor((Date.now() - new Date(lastBackup).getTime()) / (1000 * 60 * 60 * 24)) : 999;

        return (
          <div className="min-h-screen p-4">
            <div className="max-w-4xl mx-auto">
              <h1 className="text-4xl font-bold mb-4 text-center">Vita</h1>
              <div className="flex gap-2 justify-center mb-6 flex-wrap">
                <button onClick={() => setView('today')} className="px-4 py-2 bg-slate-700 text-gray-300 rounded-lg text-sm">Today</button>
                <button onClick={() => setView('progress')} className="px-4 py-2 bg-slate-700 text-gray-300 rounded-lg text-sm">Progress</button>
                <button onClick={() => setView('workouts')} className="px-4 py-2 bg-slate-700 text-gray-300 rounded-lg text-sm">Workouts</button>
                <button onClick={() => setView('affirmations')} className="px-4 py-2 bg-slate-700 text-gray-300 rounded-lg text-sm">Affirmations</button>
                <button onClick={() => setView('data')} className="px-4 py-2 bg-amber-600 text-white rounded-lg text-sm">Data</button>
              </div>

              {/* Data Management Header */}
              <div className="mb-6">
                <div className="flex items-center justify-center mb-4">
                  <div className="h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent flex-1"></div>
                  <span className="px-4 text-sm font-medium text-slate-400 bg-slate-900">üíæ DATA MANAGEMENT</span>
                  <div className="h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent flex-1"></div>
                </div>
                <p className="text-center text-slate-500 text-sm mb-6">Backup, restore, and manage your personal data</p>
              </div>

              {/* Data Statistics */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div className="bg-slate-800 rounded-xl p-4 border border-slate-700 text-center">
                  <div className="text-2xl mb-2">üìä</div>
                  <div className="text-lg font-bold text-blue-400">{history.length}</div>
                  <div className="text-sm text-gray-400">Days Tracked</div>
                </div>
                <div className="bg-slate-800 rounded-xl p-4 border border-slate-700 text-center">
                  <div className="text-2xl mb-2">üìö</div>
                  <div className="text-lg font-bold text-green-400">{knowledgeBase.length}</div>
                  <div className="text-sm text-gray-400">Knowledge Items</div>
                </div>
                <div className="bg-slate-800 rounded-xl p-4 border border-slate-700 text-center">
                  <div className="text-2xl mb-2">üèÜ</div>
                  <div className="text-lg font-bold text-purple-400">{badges.length}</div>
                  <div className="text-sm text-gray-400">Achievements</div>
                </div>
              </div>

              {/* Backup Status */}
              {daysSinceBackup > 7 && (
                <div className="bg-yellow-900 border border-yellow-600 rounded-xl p-4 mb-6">
                  <div className="flex items-center gap-3">
                    <span className="text-yellow-400 text-xl">‚ö†Ô∏è</span>
                    <div>
                      <h3 className="font-bold text-yellow-400">Backup Recommended</h3>
                      <p className="text-sm text-yellow-200">
                        It's been {daysSinceBackup} days since your last backup. Regular backups protect your data.
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Data Actions */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Export Section */}
                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                  <h3 className="text-lg font-bold mb-4 text-green-400">üì§ Export Data</h3>
                  <p className="text-sm text-gray-300 mb-4">
                    Download a backup of all your data. Keep this file safe - it contains your complete Vita history.
                  </p>
                  <div className="space-y-3">
                    <button
                      onClick={exportData}
                      className="w-full py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors"
                    >
                      üì• Download Backup
                    </button>
                    <p className="text-xs text-gray-500">
                      Last backup: {lastBackup ? new Date(lastBackup).toLocaleDateString() : 'Never'}
                    </p>
                  </div>
                </div>

                {/* Import Section */}
                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                  <h3 className="text-lg font-bold mb-4 text-blue-400">üì• Import Data</h3>
                  <p className="text-sm text-gray-300 mb-4">
                    Restore data from a previous backup. This will replace your current data.
                  </p>
                  <div className="space-y-3">
                    <input
                      type="file"
                      accept=".json"
                      onChange={importData}
                      className="w-full p-3 bg-slate-700 rounded text-white text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-medium file:bg-blue-600 file:text-white hover:file:bg-blue-700"
                    />
                    <p className="text-xs text-gray-500">
                      Select a Vita backup file (.json)
                    </p>
                  </div>
                </div>
              </div>

              {/* Data Security Info */}
              <div className="mt-8 bg-slate-800 rounded-xl p-6 border border-slate-700">
                <h3 className="text-lg font-bold mb-4 text-amber-400">üîí Data Security</h3>
                <div className="space-y-3 text-sm text-gray-300">
                  <div className="flex items-start gap-3">
                    <span className="text-green-400 mt-1">‚úÖ</span>
                    <div>
                      <strong>Local Storage:</strong> All data stays on your device
                    </div>
                  </div>
                  <div className="flex items-start gap-3">
                    <span className="text-green-400 mt-1">‚úÖ</span>
                    <div>
                      <strong>No Cloud Required:</strong> Works offline completely
                    </div>
                  </div>
                  <div className="flex items-start gap-3">
                    <span className="text-blue-400 mt-1">üí°</span>
                    <div>
                      <strong>Regular Backups:</strong> Export weekly to prevent data loss
                    </div>
                  </div>
                  <div className="flex items-start gap-3">
                    <span className="text-amber-400 mt-1">‚ö†Ô∏è</span>
                    <div>
                      <strong>Device Changes:</strong> Backup before switching devices
                    </div>
                  </div>
                </div>
              </div>

              {/* PWA Installation Info */}
              <div className="mt-6 bg-slate-800 rounded-xl p-6 border border-slate-700">
                <h3 className="text-lg font-bold mb-4 text-purple-400">üì± PWA Installation</h3>
                <p className="text-sm text-gray-300 mb-3">
                  Vita is now a Progressive Web App! Install it on your device for a native app experience:
                </p>
                <div className="space-y-2 text-sm text-gray-400">
                  <div>‚Ä¢ <strong>iPhone:</strong> Tap share button ‚Üí "Add to Home Screen"</div>
                  <div>‚Ä¢ <strong>Android:</strong> Tap menu ‚Üí "Add to Home Screen"</div>
                  <div>‚Ä¢ <strong>Desktop:</strong> Click install button in address bar</div>
                </div>
              </div>
            </div>
          </div>

        const total = 18;
        const done = data.done ? data.done.length : 0;

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
          <div className="max-w-4xl mx-auto p-4 space-y-6">
            {/* Beautiful Hero Header */}
            <div className="relative overflow-hidden bg-gradient-to-r from-amber-900/40 via-orange-900/40 to-rose-900/40 rounded-2xl p-8 border border-amber-700/30 backdrop-blur-sm">
              <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wMyI+PHBhdGggZD0iTTM2IDM0djItSDI0di0yaDEyek0zNiAyNHYySDE0di0yaDIyek0zNiAxNHYySDE0di0yaDIyeiIvPjwvZz48L2c+PC9zdmc+')] opacity-50"></div>
              <div className="relative flex justify-between items-start">
                <div>
                  <h1 className="text-4xl font-black bg-gradient-to-r from-amber-200 via-orange-200 to-rose-200 bg-clip-text text-transparent tracking-tight">
                    Vita
                  </h1>
                  <p className="text-amber-200/70 mt-1 text-lg">
                    {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                  </p>
                  <div className="flex items-center gap-4 mt-4">
                    <div className={`px-4 py-2 rounded-xl text-sm font-medium ${isExisting ? 'bg-green-500/20 text-green-200 border border-green-500/30' : 'bg-blue-500/20 text-blue-200 border border-blue-500/30'}`}>
                      {isExisting ? '‚ú® Continuing Day' : 'üåÖ Fresh Start'}
                    </div>
                    <button
                      onClick={startNewDay}
                      className="px-4 py-2 bg-slate-700/50 hover:bg-slate-600/50 text-white rounded-xl text-sm font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50"
                    >
                      New Day
                    </button>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-4xl font-bold text-amber-400">{done}/{total}</div>
                  <div className="text-sm text-amber-200/70">tasks completed</div>
                  <div className="w-24 h-2 bg-slate-700/50 rounded-full mt-2 overflow-hidden">
                    <div
                      className="h-full bg-gradient-to-r from-amber-400 to-orange-400 rounded-full transition-all duration-500"
                      style={{ width: `${(done/total)*100}%` }}
                    />
                  </div>
                </div>
              </div>

              {saveStatus && (
                <div className="mt-4 p-3 bg-green-500/20 border border-green-500/30 rounded-xl">
                  <p className="text-center text-sm text-green-200">{saveStatus}</p>
                </div>
              )}
            </div>

            {/* Modern Navigation */}
            <div className="flex gap-2 justify-center flex-wrap">
              <button onClick={() => setView('today')} className="group relative px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-bold shadow-lg shadow-amber-500/25 transition-all duration-300">
                <span className="flex items-center gap-2">
                  <span className="text-lg">üè†</span>
                  Today
                </span>
              </button>
              <button onClick={() => setView('progress')} className="group relative px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50">
                <span className="flex items-center gap-2">
                  <span className="text-lg">üìä</span>
                  Progress
                </span>
              </button>
              <button onClick={() => setView('workouts')} className="group relative px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50">
                <span className="flex items-center gap-2">
                  <span className="text-lg">üí™</span>
                  Workouts
                </span>
              </button>
              <button onClick={() => setView('life-tracker')} className="group relative px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 text-gray-300 rounded-xl font-medium transition-all duration-200 border border-slate-600/50 hover:border-slate-500/50">
                <span className="flex items-center gap-2">
                  <span className="text-lg">üìÖ</span>
                  Life Tracker
                </span>
              </button>
            </div>

            {/* Today's Focus Card */}
            <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-6 border border-slate-700/50">
              <div className="flex items-center gap-3 mb-4">
                <span className="text-3xl">üéØ</span>
                <div>
                  <h3 className="text-lg font-bold text-amber-400">Today's Focus</h3>
                  <p className="text-sm text-gray-400">Your personalized daily guidance</p>
                </div>
              </div>
              <div className="bg-gradient-to-r from-amber-900/50 to-orange-900/50 rounded-xl p-4 border border-amber-700/30">
                <p className="text-white leading-relaxed">{dailyFocus}</p>
              </div>
            </div>

            {/* Quick Stats Grid */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700/50 text-center">
                <div className="text-2xl font-bold text-amber-400">{done}/{total}</div>
                <div className="text-xs text-gray-400 mt-1">Tasks Done</div>
                <div className="w-full bg-slate-700/50 rounded-full h-1.5 mt-2 overflow-hidden">
                  <div className="h-full bg-gradient-to-r from-amber-400 to-orange-400 rounded-full transition-all duration-500" style={{ width: `${(done/total)*100}%` }} />
                </div>
              </div>

              <div className="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700/50 text-center">
                <div className="text-2xl font-bold text-green-400">{data.workoutDone ? '‚úÖ' : '‚è≥'}</div>
                <div className="text-xs text-gray-400 mt-1">Workout</div>
              </div>

              <div className="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700/50 text-center">
                <div className="text-2xl font-bold text-blue-400">{data.mood || 'üòä'}</div>
                <div className="text-xs text-gray-400 mt-1">Mood</div>
              </div>

              <div className="bg-slate-800/50 backdrop-blur rounded-xl p-4 border border-slate-700/50 text-center">
                <div className="text-2xl font-bold text-purple-400">{data.water || 0}</div>
                <div className="text-xs text-gray-400 mt-1">Water (oz)</div>
              </div>
            </div>

            {/* Save Progress Card */}
            <div className="bg-gradient-to-r from-green-900/50 to-emerald-900/50 backdrop-blur rounded-2xl p-6 border border-green-700/30">
              <div className="text-center">
                <div className="text-4xl mb-2">üíæ</div>
                <h3 className="text-lg font-bold text-green-200 mb-2">Save Today's Progress</h3>
                <p className="text-sm text-green-200/70 mb-4">
                  Capture this moment - all your tasks, workouts, mood, and insights will be saved to your progress history.
                </p>
                <button
                  onClick={async () => {
                    // Include nutrition data in the snapshot
                    const currentNutritionData = (() => {
                      try {
                        const savedNutrition = localStorage.getItem('vita-nutrition');
                        if (savedNutrition) {
                          const nutritionData = JSON.parse(savedNutrition);
                          return nutritionData[today] || null;
                        }
                        return null;
                      } catch (e) {
                        console.error('Error loading nutrition for save:', e);
                        return null;
                      }
                    })();

                    const currentData = {
                      ...data,
                      date: today,
                      lastSaved: new Date().toISOString(),
                      nutritionData: currentNutritionData
                    };
                    const cleanData = JSON.parse(JSON.stringify(currentData));
                    setData(cleanData);
                    await save(cleanData);
                    setSaveStatus('Today\'s progress saved! üìÖ');
                    setTimeout(() => setSaveStatus(''), 3000);
                  }}
                  className="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 text-white rounded-xl font-bold shadow-lg transition-all duration-300 hover:scale-105 hover:shadow-green-500/40"
                >
                  üíæ Save Today's Progress
                </button>
              </div>
            </div>
            </div>

            <div className="bg-slate-800 rounded-xl p-6 mb-6 border border-slate-700">
              <h3 className="mb-4">üòä Mood & Energy</h3>

              <div className="mb-4">
                <h4 className="text-sm font-medium text-gray-400 mb-2">How are you feeling?</h4>
              <div className="flex gap-2 flex-wrap">
                {['üòä Sharp', 'üôÇ Good', 'üòê Okay', 'üòî Off', 'üò∞ Hard'].map(m => (
                    <button key={m} onClick={async () => { const nd = { ...data, mood: m }; const cleanData = JSON.parse(JSON.stringify(nd)); setData(cleanData); await save(cleanData); }} className={`px-4 py-2 rounded-lg ${data.mood === m ? 'bg-amber-500 text-white' : 'bg-slate-700 text-gray-300'}`}>
                    {m}
                  </button>
                ))}
                </div>
              </div>

              <div>
                <h4 className="text-sm font-medium text-gray-400 mb-2">Energy Level</h4>
                <div className="flex gap-2 flex-wrap">
                  {[
                    { emoji: '‚ö°', label: 'High Energy', value: 'high' },
                    { emoji: 'üîã', label: 'Good Energy', value: 'good' },
                    { emoji: 'ü™´', label: 'Low Energy', value: 'low' },
                    { emoji: 'üò¥', label: 'Exhausted', value: 'exhausted' }
                  ].map(e => (
                    <button key={e.value} onClick={async () => { const nd = { ...data, energyLevel: e.value }; const cleanData = JSON.parse(JSON.stringify(nd)); setData(cleanData); await save(cleanData); }} className={`px-4 py-2 rounded-lg ${data.energyLevel === e.value ? 'bg-blue-500 text-white' : 'bg-slate-700 text-gray-300'}`}>
                      {e.emoji} {e.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="bg-slate-800 rounded-xl p-6 mb-6 border border-slate-700">
              <div className="flex justify-between items-center mb-3">
                <div className="flex items-center gap-2">üíß<span className="ml-1">Water Intake</span></div>
                <span className="text-xl font-bold text-blue-400">{water} glasses</span>
              </div>
              <div className="flex gap-2">
                <button onClick={() => updateWater(-1)} className="px-6 py-2 bg-slate-700 text-white rounded-lg font-bold">-</button>
                <button onClick={() => updateWater(1)} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">+ Glass</button>
              </div>
              <p className="text-xs text-gray-400 mt-2">Target: 8 glasses per day (64oz)</p>
            </div>

            {/* Task Sections Container */}
            <div className="space-y-6">
              <div className="bg-slate-800 rounded-xl p-6 mb-6 border border-slate-700">
                <div className="flex items-center gap-2 mb-3">üíª<span>SaaS Work</span></div>
              <textarea value={saas} onChange={e => setSaas(e.target.value)} onBlur={async () => { const nd = { ...data, saas }; const cleanData = JSON.parse(JSON.stringify(nd)); setData(cleanData); await save(cleanData); }} placeholder="What did you work on today?" className="w-full p-3 bg-slate-700 rounded text-white mb-3" rows="3" />
              <div className="grid grid-cols-2 gap-3 mb-3">
                <input type="number" step="0.5" value={deepWork} onChange={e => setDeepWork(e.target.value)} onBlur={async () => { const nd = { ...data, deepWork }; const cleanData = JSON.parse(JSON.stringify(nd)); setData(cleanData); await save(cleanData); }} placeholder="Deep work (hrs)" className="p-3 bg-slate-700 rounded text-white" />
                <input type="number" value={talks} onChange={e => setTalks(e.target.value)} onBlur={async () => { const nd = { ...data, talks }; const cleanData = JSON.parse(JSON.stringify(nd)); setData(cleanData); await save(cleanData); }} placeholder="User talks" className="p-3 bg-slate-700 rounded text-white" />
              </div>
              <button onClick={async () => { const nd = { ...data, saas, deepWork, talks }; const cleanData = JSON.parse(JSON.stringify(nd)); setData(cleanData); await save(cleanData); setSaveStatus('SaaS work saved! ‚úì'); setTimeout(() => setSaveStatus(''), 2000); }} className="w-full py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                Save SaaS Work
              </button>
            </div>

            <div className="bg-slate-800 rounded-xl p-6 mb-6 border border-slate-700">
              <h3 className="mb-3">Non-Negotiables</h3>
              {tasks.core.map(t => (
                <div key={t.id} onClick={() => toggle(t.id)} className={`p-3 rounded-lg mb-2 cursor-pointer ${data.done.includes(t.id) ? 'bg-green-900 border-2 border-green-500' : 'bg-slate-700'}`}>
                  <div className="flex items-center justify-between">
                    <span className="text-sm">{t.t}</span>
                    {data.done.includes(t.id) && <span>‚úÖ</span>}
                  </div>
                </div>
              ))}
            </div>

            <div className="bg-slate-800 rounded-xl p-6 mb-6 border border-slate-700">
              <h3 className="mb-3">Leadership (Do 1+)</h3>
              {tasks.lead.map(t => (
                <div key={t.id} onClick={() => toggle(t.id)} className={`p-3 rounded-lg mb-2 cursor-pointer ${data.done.includes(t.id) ? 'bg-amber-900 border-2 border-amber-500' : 'bg-slate-700'}`}>
                  <div className="flex items-center justify-between">
                    <span className="text-sm">{t.t}</span>
                    {data.done.includes(t.id) && <span>‚úÖ</span>}
                  </div>
                </div>
              ))}
            </div>

            <div className="bg-slate-800 rounded-xl p-6 mb-6 border border-slate-700">
              <h3 className="mb-3">Communication</h3>
              {tasks.comm.map(t => (
                <div key={t.id} onClick={() => toggle(t.id)} className={`p-3 rounded-lg mb-2 cursor-pointer ${data.done.includes(t.id) ? 'bg-purple-900 border-2 border-purple-500' : 'bg-slate-700'}`}>
                  <div className="flex items-center justify-between">
                    <span className="text-sm">{t.t}</span>
                    {data.done.includes(t.id) && <span>‚úÖ</span>}
                  </div>
                </div>
              ))}
            </div>


            <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
              <div className="flex items-center gap-2 mb-3">üìö<span>Reflection</span></div>
              <textarea value={journal} onChange={e => setJournal(e.target.value)} onBlur={async () => { const nd = { ...data, journal }; const cleanData = JSON.parse(JSON.stringify(nd)); setData(cleanData); await save(cleanData); }} placeholder="What did I lead? What did I ship? How did I grow?" className="w-full p-3 bg-slate-700 rounded text-white mb-3" rows="4" />
              <button onClick={async () => { const nd = { ...data, journal }; const cleanData = JSON.parse(JSON.stringify(nd)); setData(cleanData); await save(cleanData); setSaveStatus('Reflection saved! ‚úì'); setTimeout(() => setSaveStatus(''), 2000); }} className="w-full py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 transition-colors">
                Save Reflection
              </button>
            </div>
            </div> {/* End Task Sections Container */}

          </div>
        </div>
        );
      }

      if (view === 'life-tracker') {
        const eventTypes = [
          { id: 'birthday', label: 'üéÇ Birthday', color: 'pink' },
          { id: 'maintenance', label: 'üîß Maintenance', color: 'blue' },
          { id: 'renewal', label: 'üìã Renewal', color: 'green' },
          { id: 'health', label: 'üíä Health', color: 'red' },
          { id: 'anniversary', label: 'üíç Anniversary', color: 'purple' },
          { id: 'subscription', label: 'üí≥ Subscription', color: 'orange' },
          { id: 'custom', label: '‚≠ê Custom', color: 'amber' }
        ];

        const recurrenceOptions = [
          { id: 'yearly', label: 'Yearly' },
          { id: 'quarterly', label: 'Every 3 Months' },
          { id: 'monthly', label: 'Monthly' },
          { id: 'once', label: 'One-time' }
        ];

        const getEventIcon = (type) => {
          const icons = { birthday: 'üéÇ', maintenance: 'üîß', renewal: 'üìã', health: 'üíä', anniversary: 'üíç', subscription: 'üí≥', custom: '‚≠ê' };
          return icons[type] || 'üìå';
        };

        const getEventColor = (type) => {
          const colors = {
            birthday: 'from-pink-600 to-rose-600',
            maintenance: 'from-blue-600 to-cyan-600',
            renewal: 'from-green-600 to-emerald-600',
            health: 'from-red-600 to-orange-600',
            anniversary: 'from-purple-600 to-violet-600',
            subscription: 'from-orange-600 to-yellow-600',
            custom: 'from-amber-600 to-yellow-600'
          };
          return colors[type] || 'from-slate-600 to-slate-700';
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
            <div className="max-w-4xl mx-auto p-4 space-y-6">
              {/* Beautiful Header */}
              <div className="relative overflow-hidden bg-gradient-to-r from-amber-900/40 via-orange-900/40 to-rose-900/40 rounded-2xl p-8 border border-amber-700/30 backdrop-blur-sm">
                <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wMyI+PHBhdGggZD0iTTM2IDM0djItSDI0di0yaDEyek0zNiAyNHYySDE0di0yaDIyek0zNiAxNHYySDE0di0yaDIyeiIvPjwvZz48L2c+PC9zdmc+')] opacity-50"></div>
                <div className="relative flex justify-between items-center">
                  <div>
                    <h1 className="text-3xl font-black bg-gradient-to-r from-amber-200 via-orange-200 to-rose-200 bg-clip-text text-transparent tracking-tight">
                      Life Tracker
                    </h1>
                    <p className="text-amber-200/70 mt-1 text-sm">Never miss important dates & reminders</p>
                  </div>
                  <button
                    onClick={() => setShowEventModal(true)}
                    className="group relative px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 text-white rounded-xl font-bold shadow-lg shadow-amber-500/25 transition-all duration-300 hover:scale-105 hover:shadow-amber-500/40"
                  >
                    <span className="flex items-center gap-2">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                      Add Event
                    </span>
                  </button>
                </div>

                {/* Quick Stats */}
                <div className="relative grid grid-cols-3 gap-4 mt-6">
                  <div className="bg-white/5 backdrop-blur rounded-xl p-4 border border-white/10">
                    <p className="text-3xl font-bold text-amber-400">{eventNotifications.filter(e => e.isUrgent).length}</p>
                    <p className="text-xs text-gray-400 mt-1">Due Soon</p>
                  </div>
                  <div className="bg-white/5 backdrop-blur rounded-xl p-4 border border-white/10">
                    <p className="text-3xl font-bold text-green-400">{eventNotifications.filter(e => e.isThisWeek).length}</p>
                    <p className="text-xs text-gray-400 mt-1">This Week</p>
                  </div>
                  <div className="bg-white/5 backdrop-blur rounded-xl p-4 border border-white/10">
                    <p className="text-3xl font-bold text-blue-400">{lifeEvents.length}</p>
                    <p className="text-xs text-gray-400 mt-1">Total Events</p>
                  </div>
                </div>
              </div>

              {/* Urgent Notifications */}
              {eventNotifications.length > 0 && (
                <div className="space-y-4">
                  <h2 className="text-lg font-bold text-white flex items-center gap-2">
                    <span className="w-2 h-2 bg-amber-400 rounded-full animate-pulse"></span>
                    Upcoming Events
                  </h2>
                  <div className="grid gap-3">
                    {eventNotifications.map((event) => (
                      <div
                        key={event.id}
                        className={`relative overflow-hidden rounded-xl border transition-all duration-300 hover:scale-[1.02] ${
                          event.isToday
                            ? 'bg-gradient-to-r from-green-900/50 to-emerald-900/50 border-green-500/50 shadow-lg shadow-green-500/20'
                            : event.isUrgent
                              ? 'bg-gradient-to-r from-red-900/50 to-orange-900/50 border-red-500/50 shadow-lg shadow-red-500/20'
                              : event.isThisWeek
                                ? 'bg-gradient-to-r from-amber-900/30 to-orange-900/30 border-amber-500/30'
                                : 'bg-slate-800/50 border-slate-700/50'
                        }`}
                      >
                        <div className="p-4">
                          <div className="flex justify-between items-start">
                            <div className="flex items-center gap-3">
                              <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${getEventColor(event.type)} flex items-center justify-center text-2xl shadow-lg`}>
                                {getEventIcon(event.type)}
                              </div>
                              <div>
                                <h3 className="font-bold text-white text-lg">{event.name}</h3>
                                <p className="text-sm text-gray-400">
                                  {event.nextDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}
                                  {event.recurrence !== 'once' && <span className="ml-2 text-xs opacity-60">‚Ä¢ {event.recurrence}</span>}
                                </p>
                                {event.notes && <p className="text-xs text-gray-500 mt-1">{event.notes}</p>}
                              </div>
                            </div>
                            <div className="text-right">
                              {event.isToday ? (
                                <span className="inline-flex items-center gap-1 px-3 py-1 bg-green-500 text-white text-sm font-bold rounded-full animate-pulse">
                                  üéâ TODAY!
                                </span>
                              ) : event.isUrgent ? (
                                <span className="inline-flex items-center gap-1 px-3 py-1 bg-red-500 text-white text-sm font-bold rounded-full">
                                  ‚ö†Ô∏è {event.daysUntil}d
                                </span>
                              ) : (
                                <span className="inline-flex items-center gap-1 px-3 py-1 bg-slate-600 text-gray-200 text-sm rounded-full">
                                  {event.daysUntil} days
                                </span>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* All Events by Category */}
              <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-6 border border-slate-700/50">
                <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                  üìÖ All Events
                </h2>
                {lifeEvents.length === 0 ? (
                  <div className="text-center py-12">
                    <div className="text-6xl mb-4 opacity-50">üìå</div>
                    <p className="text-gray-400 text-lg">No events yet</p>
                    <p className="text-gray-500 text-sm mt-2">Add birthdays, maintenance reminders, renewals & more!</p>
                    <button
                      onClick={() => setShowEventModal(true)}
                      className="mt-4 px-6 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-medium transition-colors"
                    >
                      Add Your First Event
                    </button>
                  </div>
                ) : (
                  <div className="grid gap-3">
                    {lifeEvents.map((event) => (
                      <div key={event.id} className="group flex justify-between items-center p-4 bg-slate-700/30 hover:bg-slate-700/50 rounded-xl border border-slate-600/30 transition-all duration-200">
                        <div className="flex items-center gap-3">
                          <div className={`w-10 h-10 rounded-lg bg-gradient-to-br ${getEventColor(event.type)} flex items-center justify-center text-xl`}>
                            {getEventIcon(event.type)}
                          </div>
                          <div>
                            <span className="font-semibold text-white">{event.name}</span>
                            <div className="flex items-center gap-2 text-sm text-gray-400">
                              <span>{event.month}/{event.day}</span>
                              <span className="text-xs px-2 py-0.5 bg-slate-600 rounded">{event.recurrence}</span>
                            </div>
                          </div>
                        </div>
                        <button
                          onClick={() => removeLifeEvent(event.id)}
                          className="opacity-0 group-hover:opacity-100 px-3 py-1.5 bg-red-600/80 hover:bg-red-500 text-white text-xs rounded-lg transition-all duration-200"
                        >
                          Remove
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Back to Today */}
              <div className="text-center pb-8">
                <button
                  onClick={() => setView('today')}
                  className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-gray-300 rounded-lg transition-colors"
                >
                  ‚Üê Back to Today
                </button>
              </div>
          </div>

          {/* Add Event Modal */}
          {showEventModal && (
            <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
              <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 max-w-md w-full shadow-2xl">
                <h3 className="text-2xl font-bold bg-gradient-to-r from-amber-200 to-orange-200 bg-clip-text text-transparent mb-6">Add New Event</h3>

                <div className="space-y-5">
                  {/* Event Type */}
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">Event Type</label>
                    <div className="grid grid-cols-4 gap-2">
                      {eventTypes.slice(0, 4).map((type) => (
                        <button
                          key={type.id}
                          onClick={() => setNewEvent({...newEvent, type: type.id})}
                          className={`p-3 rounded-xl border-2 transition-all text-center ${
                            newEvent.type === type.id
                              ? 'border-amber-500 bg-amber-500/20'
                              : 'border-slate-600 bg-slate-700/30 hover:border-slate-500'
                          }`}
                        >
                          <div className="text-2xl mb-1">{type.label.split(' ')[0]}</div>
                          <div className="text-xs text-gray-400">{type.label.split(' ')[1]}</div>
                        </button>
                      ))}
                    </div>
                    <div className="grid grid-cols-3 gap-2 mt-2">
                      {eventTypes.slice(4).map((type) => (
                        <button
                          key={type.id}
                          onClick={() => setNewEvent({...newEvent, type: type.id})}
                          className={`p-2 rounded-xl border-2 transition-all text-center ${
                            newEvent.type === type.id
                              ? 'border-amber-500 bg-amber-500/20'
                              : 'border-slate-600 bg-slate-700/30 hover:border-slate-500'
                          }`}
                        >
                          <div className="text-xl">{type.label.split(' ')[0]}</div>
                          <div className="text-xs text-gray-400">{type.label.split(' ')[1]}</div>
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Name */}
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-1">Name / Description</label>
                    <input
                      type="text"
                      value={newEvent.name}
                      onChange={(e) => setNewEvent({...newEvent, name: e.target.value})}
                      className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-gray-500 focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-colors"
                      placeholder="e.g., HVAC Filter Change, Mom's Birthday"
                    />
                  </div>

                  {/* Date */}
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-300 mb-1">Month</label>
                      <select
                        value={newEvent.month}
                        onChange={(e) => setNewEvent({...newEvent, month: e.target.value})}
                        className="w-full px-3 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white focus:border-amber-500 transition-colors"
                      >
                        <option value="">Select</option>
                        {Array.from({length: 12}, (_, i) => (
                          <option key={i+1} value={i+1}>
                            {new Date(0, i).toLocaleString('default', { month: 'long' })}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-300 mb-1">Day</label>
                      <select
                        value={newEvent.day}
                        onChange={(e) => setNewEvent({...newEvent, day: e.target.value})}
                        className="w-full px-3 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white focus:border-amber-500 transition-colors"
                      >
                        <option value="">Select</option>
                        {Array.from({length: 31}, (_, i) => (
                          <option key={i+1} value={i+1}>{i+1}</option>
                        ))}
                      </select>
                    </div>
                  </div>

                  {/* Recurrence */}
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">Repeat</label>
                    <div className="grid grid-cols-4 gap-2">
                      {recurrenceOptions.map((option) => (
                        <button
                          key={option.id}
                          onClick={() => setNewEvent({...newEvent, recurrence: option.id})}
                          className={`p-2 rounded-lg border-2 text-sm transition-all ${
                            newEvent.recurrence === option.id
                              ? 'border-amber-500 bg-amber-500/20 text-white'
                              : 'border-slate-600 bg-slate-700/30 text-gray-400 hover:border-slate-500'
                          }`}
                        >
                          {option.label}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Notes */}
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-1">Notes (Optional)</label>
                    <input
                      type="text"
                      value={newEvent.notes}
                      onChange={(e) => setNewEvent({...newEvent, notes: e.target.value})}
                      className="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-gray-500 focus:border-amber-500 transition-colors"
                      placeholder="e.g., Buy 20x25x1 filter from Home Depot"
                    />
                  </div>
                </div>

                <div className="flex gap-3 mt-8">
                  <button
                    onClick={() => {
                      setShowEventModal(false);
                      setNewEvent({ name: '', type: 'birthday', month: '', day: '', year: '', recurrence: 'yearly', notes: '' });
                    }}
                    className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={addLifeEvent}
                    className="flex-1 px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 text-white rounded-xl font-bold shadow-lg transition-all"
                  >
                    Add Event
                  </button>
                </div>
              </div>
            </div>
          )}
        );
      }

    ReactDOM.render(<VitaApp />, document.getElementById('root'));

    // Register Service Worker for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then((registration) => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>

</body>
</html>

